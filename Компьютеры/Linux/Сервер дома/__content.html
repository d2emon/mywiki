<!DOCTYPE html>
<HTML>
<HEAD>
	<META HTTP-EQUIV='CONTENT-TYPE' CONTENT='TEXT/HTML; CHARSET=UTF-8'/>

	<STYLE type="text/css">
		body, div, p, table {
			font-size:10pt;
			font-family:Verdana;
		}

		img{border:none}
		
	</STYLE>
	
</HEAD>

<BODY>
<P>
<H1>Сервер дома — AMD, Debian x64, Bind9, Apache 2, PHP5, MySQL5, Trac, Subversion и море удовольствия</H1></P>

<P>Шило в известном месте всё никак не даёт мне покоя. И решил я поэкспериментировать с установкой сервера дома.</P>

<P>Итак, дано:</P>

<P>
<OL>
<LI>Домашний интернет с внешним ip на роутере, канал туда/обратно — 8 мбит, провайдер — QWERTY *</LI>
<LI>Бюджет не больше 10 тысяч рублей — чем меньше, тем лучше. **</LI>
<LI>Жгучее желание экспериментов и чего-нибудь эдакого ***</LI>
</OL> * К сожалению, мой дом не подключает Корбина, у которой более широкие каналы. Приходится довольствоваться тем, что есть
<BR> ** Получилось путём более-менее реального подсчёта стоимости комплектующих на среднестатический компьютер
<BR> *** Для тех, кто хмыкнет и скажет — «эка невидаль, я такое регулярно делаю» — я не так часто что-то настраиваю, больше пишу под уже настроенное, и для меня это чистой воды развлечение — что-то сделать своими руками=)</P>

<P>Ну, все процедуры тут, под катом.</P>

<P>Сразу хочу сказать, что у меня это работает — так, как есть. Дополнительно с бубном я не плясал — но тут вытяжки из моих гуглений и мануалокурений.</P>

<P>Вероятно, что-то можно настроить более гибко или качественно, и я крайне буду рад советам или решениям=)</P>

<P>
<BR>Подумал, что надо покупать:</P>

<P>
<OL>
<LI>Материнская плата</LI>
<LI>Процессор</LI>
<LI>Жёсткий диск</LI>
<LI>Память</LI>
<LI>Корпус</LI>
<LI>Кулер на процессор</LI>
</OL>Выбрал магазин Oldi, собрал online комплектующих на сумму как раз около 10 тысяч — упирая на Intel. Всю ночь ворочался, думал, и на следующее утро пересобрал заказ, упирая на AMD. Разница в деньгах получилась около двух тысяч, а AMD-конфигурация — более подверженная будущим апгрейдам. Например, на Socket 775 в Oldi не было материнских плат до 2k, позволяющих добить оперативку до 16 гигабайт. В общем, решил попробовать — ибо с AMD давно не имел дела.
<BR>Проц — AMD x64 2.4 ггц, жёсткий диск взял один, SATAII на 320 гигабайт (как вариант — куплю ещё один расширю до рейд 1), памяти — Кингстон 800мгц, две планки по 2 гигабайта (поставились в Dual), самый дешевый корпус и кулер Igloo — не блистающий дороговизной, но вполне себе охлаждающий (за несколько дней температура не превысила 60 градусов, судя по sensors).</P>

<P>Торжественно с этим всем приехал домой, собрал, подключил к монитору, подключил клавиатуру, провод от роутера, внешний USB-привод, и через полчаса уже смотрел на свежепоставленный Debian.</P>

<P>Настроил переадресацию портов на роутере:</P>

<P>
<PRE>
53 порт =&gt; Bind9
80 порт =&gt; Apache
21 порт =&gt; FTP
22 порт =&gt; SSH
</PRE></P>

<P>После чего исполнил три команды:</P>

<P>
<PRE>
apt-get update
apt-get upgrade
apt-get install ssh 
</PRE></P>

<P>и улёгся на диван с ноутбуком, продолжая диалог с сервером уже через Putty.</P>

<P>Цели были прозаичны:</P>

<P>
<OL>
<LI>Bind9</LI>
<LI>Apache2</LI>
<LI>PHP5</LI>
<LI>MySQL 5</LI>
<LI>SVN</LI>
<LI>Trac</LI>
</OL>Всё это предполагалось сделать на одном недавно купленном домене (предположим, habr.ru), который ещё не был нигде проделегирован.</P>

<P>
<H2>Bind9. Настройка чайника.</H2></P>

<P>Учитывая то, что о настройке Bind9 лишь слышал, — сразу полез в мануалы и примеры.</P>

<P>В итоге настройку произвёл по этой инструкции, изменив лишь настройку конкретной зоны для домена. </P>

<P>Кроме того, мне хотелось сразу подключить Google Applications для домена, чтобы не иметь дел с настройкой sendmail — в настройках ниже они легко наблюдаются.</P>

<P>Получилось следующее:</P>

<P>1. Создал папку /etc/bind/sites</P>

<P>2. В настройках /etc/bind/named.conf, в самом конце:
<BR>
<PRE>
include &quot;/etc/bind/named.conf.skazkin&quot;;
</PRE></P>

<P>3. В /etc/bind/named.conf.skazkin:
<BR>
<PRE>
zone &quot;habr.ru&quot; {
type master;
file &quot;/etc/bind/sites/habr.ru&quot;;
};
</PRE></P>

<P>4. В /etc/bind/sites/habr.ru:
<BR>
<PRE>
$ORIGIN habr.ru.
$TTL 86400 ; 1 day
@ IN SOA habr.ru. master.habr.com. (
2008291104; serial
10800 ; refresh (3 hours)
3600 ; retry (15 minutes)
3600000 ; expire (1 week)
86400 ; minimum (1 day)
)
@ IN NS ns.habr.ru.
@ IN NS ns.vds.ru.
@ IN A 111.222.333.444
@ IN MX 10 ASPMX.L.GOOGLE.COM.
@ IN MX 20 ALT1.ASPMX.L.GOOGLE.COM.
@ IN MX 20 ALT2.ASPMX.L.GOOGLE.COM.
@ IN MX 30 ASPMX2.GOOGLEMAIL.COM.
@ IN MX 30 ASPMX3.GOOGLEMAIL.COM.
@ IN MX 30 ASPMX4.GOOGLEMAIL.COM.
@ IN MX 30 ASPMX5.GOOGLEMAIL.COM.

ns IN A 111.222.333.444
svn IN CNAME habr.ru.
trac IN CNAME habr.ru.
www IN CNAME habr.ru.
</PRE></P>

<P>На что хватило понимания мануала.</P>

<P>Непонятно было то, что при попытке прописать всё без @-знака, бинд переставал понимать, что от него хотят — ещё раз прорыв гугл, я подозреваю, что это из-за неправильных отступов (*hic*)?</P>

<P>В общем, тут я как-то вот выкрутился — факт остаётся фактом, домен проделегировался. Но об этом немного позже.</P>

<P>Помимо primary-зоны, мне понадобилось создать ещё и Slave. Пошёл на давно купленный VDS с как-то странно установленным дебианом, там прописал:</P>

<P>1. /etc/bind/named.conf
<BR>
<PRE>
zone &quot;habr.ru&quot; {
type slave;
file &quot;/var/cache/bind/habr.ru&quot;;
masters {
111.222.333.444;
};
};
</PRE></P>

<P>2. Соответственно, в /var/cache/bind/habr.ru всё то же, что и на домашнем сервере:
<BR>
<PRE>
$ORIGIN habr.ru.
$TTL 86400 ; 1 day
@ IN SOA habr.ru. master.habr.com. (
2008291104; serial
10800 ; refresh (3 hours)
3600 ; retry (15 minutes)
3600000 ; expire (1 week)
86400 ; minimum (1 day)
)
@ IN NS ns.habr.ru.
@ IN NS ns.vds.ru.
@ IN A 111.222.333.444
@ IN MX 10 ASPMX.L.GOOGLE.COM.
@ IN MX 20 ALT1.ASPMX.L.GOOGLE.COM.
@ IN MX 20 ALT2.ASPMX.L.GOOGLE.COM.
@ IN MX 30 ASPMX2.GOOGLEMAIL.COM.
@ IN MX 30 ASPMX3.GOOGLEMAIL.COM.
@ IN MX 30 ASPMX4.GOOGLEMAIL.COM.
@ IN MX 30 ASPMX5.GOOGLEMAIL.COM.

ns IN A 111.222.333.444
svn IN CNAME habr.ru.
trac IN CNAME habr.ru.
www IN CNAME habr.ru.
</PRE></P>

<P>После чего и дома, и на VDS сделал 
<BR>
<PRE>
/etc/init.d/bind9 restart # на всякий случай - не будет ли ошибок при рестарте
nslookup habr.ru 127.0.0.1
</PRE></P>

<P>От лукапа должен получиться успешный ресолв:
<BR>
<PRE>
bash:/etc/bind# nslookup habr.ru 127.0.0.1
Server: 127.0.0.1
Address: 127.0.0.1#53

Name: habr.ru
Address: 111.222.333.444
</PRE></P>

<P>После чего уже при следующих изменениях на домашнем сервере делал только 
<BR>
<PRE>
rnds reload
</PRE></P>

<P>На VDS отчего-то такого не было, приходилось рестартить демон. Ну, правда, там Bind8.</P>

<P>Через 6 часов, в 23 часа, получив успешную делегацию и успев поужинать, попить чаю и посмотреть телевизор, пошёл настраивать всё прилагающееся.</P>

<P>
<H2>Apache2, PHP, MySQL</H2></P>

<P>В дебиане установить апач — легче лёгкого.</P>

<P>
<PRE>
apt-get install apache2
apt-get install mysql-client mysql-server
apt-get install php5 php5-mysql php5-xmlrpc php5-cli php5-gd php5-curl php5-xsl
</PRE></P>

<P>В итоге я заполучил с пылу — с жару работающие Apache2, MySQL 5, PHP5 с нужными модулями.</P>

<P>Учитывая то, что MySQL по умолчанию ставится с пустым паролем — </P>

<P>
<PRE>
mysqladmin -uroot password мегасекурныйпароль
</PRE></P>

<P>Ну, и настроить виртуальные хосты.</P>

<P>Решаю всё хранить в /home/sites/</P>

<P>
<PRE>
mkdir /home/sites
mkdir /home/sites/habr.ru
</PRE></P>

<P>Иду в /etc/apache2/sites-availible</P>

<P>Создаю там </P>

<P>
<PRE>
touch habr.ru
ln -s /etc/apache2/sites-availible/habr.ru /etc/apache2/sites-enabled/habr.ru
</PRE></P>

<P>И в habr.ru:</P>

<P>
<PRE>
&lt;VirtualHost *&gt;
ServerAdmin master@habr.ru
DocumentRoot &quot;/home/sites/habr.ru&quot;
ServerName habr.ru
ServerAlias www.habr.ru
ErrorLog &quot;/var/log/apache2/habr.ru.error.log&quot;
CustomLog &quot;/var/log/apache2/habr.ru.access.log&quot; common
&lt;/VirtualHost&gt;
</PRE></P>

<P>Затем — рестарт апача</P>

<P>
<PRE>
/etc/init.d/apache2 restart
</PRE></P>

<P>Оставалось то, о чём я уже писал раньше, но про VDS и настраивая это в первый раз — а именно — </P>

<P>
<H2>SVN + TRAC</H2></P>

<P>Как обычно — </P>

<P>
<PRE>
apt-get install subversion
apt-get install libapache2-svn
apt-get install trac
</PRE></P>

<P>Трак подтянул за собой свои зависимости, и я приступил.</P>

<P>Я выбрал для себя хранилищем сайта папку /home/sites/habr.ru, посему решил около этого и крутиться:</P>

<P>Начал с SVN, ориентируясь на этот мануал</P>

<P>
<PRE>
mkdir /home/sites/svn
svnadmin create --fs-type fsfs /home/sites/svn
groupadd subversion
adduser svn_user --ingroup subversion
</PRE></P>

<P>Опустив строчки про авторизацию и генерацию авторизационных ключей, я сразу полез в Apache</P>

<P>Опять иду в /etc/apache2/sites-availible</P>

<P>
<PRE>
cd /etc/apache2/sites-availible
touch svn.habr.ru
ln -s /etc/apache2/sites-availible/svn.habr.ru /etc/apache2/sites-enabled/svn.habr.ru
</PRE></P>

<P>В svn.habr.ru:</P>

<P>
<PRE>
&lt;VirtualHost *&gt;
ServerAdmin master@habr.ru
DocumentRoot &quot;/home/sites/svn&quot;
ServerName svn.habr.ru
ErrorLog &quot;/var/log/apache2/svn.habr.ru.error.log&quot;
CustomLog &quot;/var/log/apache2/svn.habr.ru.access.log&quot; common
&lt;Location /&gt;
DAV svn
SVNPath /home/sites/svn
&lt;/Location&gt;
&lt;/VirtualHost&gt;
</PRE></P>

<P>Опять перезапускаю Апач:</P>

<P>
<PRE>
/etc/init.d/apache2 restart
</PRE></P>

<P>И — по svn.habr.ru — у меня находится репозиторий.</P>

<P>Попил чаю, приступил к Trac.</P>

<P>Трак решил положить в /home/sites/trac</P>

<P>Сначала создать базу и пользователя:</P>

<P>
<PRE>
mysqladmin -uroot -p create trac
</PRE></P>

<P>Выполнить запрос: GRANT SELECT,INSERT,UPDATE,DELETE,CREATE,DROP ON trac.* TO 'trac'@'localhost' IDENTIFIED BY 'tracmegapassword';</P>

<P>
<PRE>
mkdir /home/sites/trac
trac-admin initenv /home/sites/trac
</PRE></P>

<P>СВН указывается тот, что уже сделали: /home/sites/svn</P>

<P>А когда trac спросил про БД-хранилище, ответил ему:</P>

<P>
<PRE>
mysql://trac:tracmegapassword@localhost:3306/trac
</PRE></P>

<P>Подправил руками /home/sites/trac/conf/trac.ini — всякие мелкие параметры, и в секции [trac] указал:</P>

<P>
<PRE>
[trac]
...
htdocs_location = /tracdocs/
</PRE></P>

<P>После чего полез в конфиг Apache — создавать хост.</P>

<P>
<PRE>
cd /etc/apache2/sites-availible/
touch trac.habr.ru
ln -s /etc/apache2/sites-availible/trac.habr.ru /etc/apache2/sites-enabled/trac.habr.ru
</PRE></P>

<P>В самом trac.habr.ru:</P>

<P>
<PRE>
&lt;VirtualHost *&gt;
ServerAdmin master@habr.ru
DocumentRoot &quot;/home/sites/trac/htdocs&quot;
ServerName trac.habr.ru
ErrorLog &quot;/var/log/apache2/trac.habr.ru.error.log&quot;
CustomLog &quot;/var/log/apache2/trac.habr.ru.access.log&quot; common

&lt;Location /&gt;
SetHandler mod_python
PythonInterpreter main_interpreter
PythonHandler trac.web.modpython_frontend
PythonOption TracEnv /home/sites/trac
PythonOption TracUriRoot /
&lt;/Location&gt;
Alias /tracdocs /usr/share/trac/htdocs
&lt;Location /tracdocs&gt;
SetHandler None
&lt;/Location&gt;
&lt;/VirtualHost&gt;
</PRE></P>

<P>После чего — рестарт апача</P>

<P>
<PRE>
/etc/init.d/apache2 restart
</PRE></P>

<P>И в итоге мы имеем незапароленные (внимательно с этим, я-то запаролил позже на глобальном уровне — а кто будет настраивать — не забудьте про секьюрность) SVN и Trac по соответствующим адресам:</P>

<P>
<PRE>
svn.habr.ru
trac.habr.ru
</PRE></P>

<P>В итоге у меня есть работающий (в ближайшем будущем на антресолях) сервер, на котором у меня поднят Trac, SVN, Apache2, MySQL, PHP, Bind9 и крутятся несколько сайтов.</P>

<P>А так же я хорошо поразвлекался и принёс пользу не только себе, но и семье — перевесив почту домашних на одном из моих доменов на гугл.апс.</P>

<P>Кроме того, я избавился от необходимости оплачивать медленную VDS (скоро перенесу secondary-зону к другу), теперь я знаю что происходит когда мои сайты недоступны (а не «у нас технические проблемы»), а так же могу делать столько доменов, субдоменов и прочего сколько хочется, а не сколько стоит в лимитах хостерского аккаунта.</P>

<P>А так же, теперь торрент качает без «технических» пауз (когда я с ноутбуком на работе).</P>

<P>Единственный минус всего этого — узкий обратный канал. Но у этого QWERTY, в котором я наблюдаюсь, есть трафиколимитированные «широкие» каналы — так что возможно, в скором будущем я буду им отстёгивать ещё 300 рублей за 100 мбит (если обратный трафик не тарифицируется), и буду проводить эксперименты с второй сетевой картой (чтобы торрент с сервера лил без лимитов по другому проводу)</P>

<P>Вот, как-то так.) Море удовольствия для меня и хорошее настроение на неделю=)</P>

<P>Дополнительно, вопрос к телезрителям: в какой блог лучше перенести для широкой публики — «Я умный», или «Linux для всех», или «Системное администрирование»?=) Учитывая не особо глубокие инструкции по применению?)</P>

<P>UPDATE: Вот только что немношка поседел — сервер перестал отзываться. Я забыл настроить самое главное — статический ip!</P>

<P>Позвонил жене, отдал инструкции о новых перенаправлениях, и — вуаля — </P>

<P>
<PRE>
mcedit /etc/network/interfaces
# удаляю всё, что относится к eth1 и добавляю:
auto eth1
iface eth1 inet static
address 192.168.1.5
netmask 255.255.255.0
network 192.168.1.0
broadcast 192.168.0.255
gateway 192.168.1.1
#сохраняю, закрываю и потом...
/etc/init.d/networking restart
</PRE></P>

<P>На одну проблему стало меньше=)</P>

<P>Сегодня приду домой и воткну туда Wi-Fi — и обновлю этот пост с учётом Wi-Fi-настройки=)</P>

<P>UPDATE2:</P>

<P>Не проверил работоспособность ProFTPD извне!</P>

<P>Надо открыть /etc/proftpd/proftpd.conf и туда:</P>

<P>
<PRE>
DefaultAddress 111.222.333.444
Port 21
PassivePorts 60000 60010
MasqueradeAddress 111.222.333.444
</PRE></P>

<P>И внести соответствующие перенаправления портов на роутере! (для пассивных портов.). У меня их 10 — потому что не ожидается много коннектов</P>
</BODY>
</HTML>