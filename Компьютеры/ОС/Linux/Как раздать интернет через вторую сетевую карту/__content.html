<!DOCTYPE html>
<HTML>
<HEAD>
	<META HTTP-EQUIV='CONTENT-TYPE' CONTENT='TEXT/HTML; CHARSET=UTF-8'/>

	<STYLE type="text/css">
		body, div, p, table {
			font-size:10pt;
			font-family:Verdana;
		}

		img{border:none}
		
	</STYLE>
	
</HEAD>

<BODY>
<P>
<H1>Как раздать интернет через вторую сетевую карту</H1></P>

<P>Дано:
<BR>Сетевая карточка eth0 подключенная с помощью PPPoE к интернету и eth1 подключенная к сети с адресом <A HREF="http://192.168.0.1">192.168.0.1</A> к которой подключена сеть с адресами 192.168.0.* в которой нужно раздать интернет.</P>

<P>Для начала включим форвардинг:</P>

<P><CODE>
<BR>echo 1 > /proc/sys/net/ipv4/ip_forward
<BR></CODE></P>

<P>Чтобы форвардинг автоматически включался при запуске системы</P>

<P>Открываем файл:</P>

<P><CODE>
<BR>sudo nano /etc/sysctl.conf
<BR></CODE></P>

<P>и добавляем в него строчку:</P>

<P><CODE>
<BR>net.ipv4.ip_forward = 1
<BR></CODE></P>

<P>Затем включаем NAT</P>

<P><CODE>
<BR>iptables -t nat -A POSTROUTING -o ppp0 -j MASQUERADE
<BR></CODE></P>

<P>Где ppp0 название вашего интерфейса через который выходите в интернет.</P>

<P>Чтобы NAT работал после перезагрузки делаем следующее:</P>

<P>сохраняем настройки iptables в файл</P>

<P><CODE>
<BR>sudo iptables-save > /etc/iptables.up.rules
<BR></CODE></P>

<P>И добавляем в конец файла:</P>

<P><CODE>
<BR>sudo nano /etc/networks/interfaces
<BR></CODE></P>

<P>эту строчку, для автоматической подгрузке правил</P>

<P><CODE>
<BR>pre-up iptables-restore < /etc/iptables.up.rules
<BR></CODE></P>

<P>Так же в этот файл добавляем правила роутинга:</P>

<P><CODE>
<BR>up route add -net <A HREF="http://192.168.0.0">192.168.0.0</A> netmask <A HREF="http://255.255.255.0">255.255.255.0</A> dev eth1
<BR>up route add -net <A HREF="http://0.0.0.0">0.0.0.0</A> netmask <A HREF="http://255.255.255.255">255.255.255.255</A> dev eth0
<BR></CODE></P>

<P>Chromium и kwalletNetHogs: мониторинг трафика по отдельным процессам</P>

<P>
<H2>Комментарии</H2></P>

<P>ну если еще и ррр0...
<BR>тогда так</P>

<P><CODE>
<BR>
<OL>
<LI>!/bin/sh</LI>
</OL>PATH=/usr/sbin:/sbin:/bin:/usr/bin</P>

<P>
<OL>
<LI></LI>
<LI>delete all existing rules.</LI>
<LI></LI>
</OL>iptables -F
<BR>iptables -t nat -F
<BR>iptables -t mangle -F
<BR>iptables -X</P>

<P>
<OL>
<LI>Always accept loopback traffic</LI>
</OL>iptables -A INPUT -i lo -j ACCEPT</P>

<P>
<OL>
<LI>Allow established connections, and those not coming from the outside</LI>
</OL>iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT
<BR>iptables -A INPUT -m state --state NEW -i ! ppp0 -j ACCEPT
<BR>iptables -A FORWARD -i ppp0 -o eth1 -m state --state ESTABLISHED,RELATED -j ACCEPT</P>

<P>
<OL>
<LI>Allow outgoing connections from the LAN side.</LI>
</OL>iptables -A FORWARD -i eth1 -o ppp0 -j ACCEPT</P>

<P>
<OL>
<LI>Masquerade.</LI>
</OL>iptables -t nat -A POSTROUTING -o ppp0 -j MASQUERADE</P>

<P>
<OL>
<LI>Don't forward from the outside to the inside.</LI>
</OL>iptables -A FORWARD -i ppp0 -o ppp0 -j REJECT
<BR>iptables -A FORWARD -i eth0 -o ppp0 -j REJECT
<BR>
<OL>
<LI>Enable routing.</LI>
</OL>echo 1 > /proc/sys/net/ipv4/ip_forward
<BR></CODE></P>

<P>ЗЫ кидаем этот файлик с любым названием в /etc/network/if-up.d/</P>

<P><HR></P>

<P>создал файлег, че-та ноут (WinXP)у меня не может подключиться к сети - адрес не назначается,
<BR>в командной строке вот чего:
<BR>stranger@stranger-desktop:~$ sudo su
<BR>[sudo] password for stranger:
<BR>root@stranger-desktop:/home/stranger# sh /etc/network/if-up.d/routing.shUsing intrapositioned negation (`--option ! this`) is deprecated in favor of extrapositioned (`! --option this`).
<BR>root@stranger-desktop:/home/stranger# sh /etc/network/if-up.d/routing.sh start
<BR>Using intrapositioned negation (`--option ! this`) is deprecated in favor of extrapositioned (`! --option this`).
<BR>Скрипт вот он:
<BR>
<OL>
<LI>!/bin/sh</LI>
</OL>PATH=/usr/sbin:/sbin:/bin:/usr/bin
<BR>
<OL>
<LI></LI>
<LI>delete all existing rules.</LI>
<LI></LI>
</OL>iptables -F
<BR>iptables -t nat -F
<BR>iptables -t mangle -F
<BR>iptables -X
<BR>
<OL>
<LI>Always accept loopback traffic</LI>
</OL>iptables -A INPUT -i lo -j ACCEPT
<BR>
<OL>
<LI>Allow established connections, and those not coming from the outside</LI>
</OL>iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT
<BR>iptables -A INPUT -m state --state NEW -i ! tap0 -j ACCEPT
<BR>iptables -A FORWARD -i tap0 -o eth1 -m state --state ESTABLISHED,RELATED -j ACCEPT
<BR>
<OL>
<LI>Allow outgoing connections from the LAN side.</LI>
</OL>iptables -A FORWARD -i eth1 -o tap0 -j ACCEPT
<BR>
<OL>
<LI>Masquerade.</LI>
</OL>iptables -t nat -A POSTROUTING -o tap0 -j MASQUERADE
<BR>
<OL>
<LI>Don't forward from the outside to the inside.</LI>
</OL>iptables -A FORWARD -i tap0 -o tap0 -j REJECT
<BR>iptables -A FORWARD -i eth0 -o tap0 -j REJECT
<BR>
<OL>
<LI>Enable routing.</LI>
</OL>echo 1 > /proc/sys/net/ipv4/ip_forward
<BR>интернет - на интерфейсе tap0</P>

<P><HR></P>

<P>А что ещё прописать в правило, чтобы помимо конкретного интерфейса ещё и через конкретный IP адрес NAT илось ?</P>

<P>Тогда использовать SNAT вместо MASQUERADE</P>

<P><CODE>
<BR> -j SNAT --to-source $ip
<BR></CODE></P>

<P>Правда, если у тебя ip динамический то тебе придется каждый раз переписывать сие правило.</P>

<P><HR></P>

<P>А как выключить NАТ ? Т.е. обратный процесс этому всему.</P>

<P>Т.е. понастраивал я это все себе правил в iptables понаписал, все прекрасно работало и ладно. А теперь "расшаривание интернета не требуется". Как это всё потереть.</P>

<P>из консоли: echo 0 > /proc/sys/net/ipv4/ip_forward
<BR>из консоли: sudo nano /etc/sysctl.conf
<BR>удаляем строку: net.ipv4.ip_forward = 1
<BR>из консоли: sudo iptables -F
<BR>из консоли: sudo iptables-save > /etc/iptables.up.rules
<BR>sudo nano /etc/networks/interfaces - удаляем строки
<BR>pre-up iptables-restore < /etc/iptables.up.rules
<BR>up route add -net <A HREF="http://192.168.0.0">192.168.0.0</A> netmask <A HREF="http://255.255.255.0">255.255.255.0</A> dev eth1
<BR>up route add -net <A HREF="http://0.0.0.0">0.0.0.0</A> netmask <A HREF="http://255.255.255.255">255.255.255.255</A> dev eth0
<BR>все :) это я тупо проделал все действия наоборот :)
<BR>iptables -F - удаляет все правила
<BR>в итоге будет как свежей кубунте.
<BR>файл /etc/iptables.up.rules вероятно будет пустой. и его можно будет удалить</P>

<P><HR></P>

<P>iptables -F - удаляет все правила</P>

<P><CODE>
<BR>man iptables
<BR></CODE></P>

<P>-F, --flush [chain]</P>

<P>Flush the selected chain (all the chains in the table if none is given). <U>This is equivalent to deleting all the rules one by one.</U></P>

<P>Как я при беглом чтении не заметил подчёркнутую строку... Что делает эта строка ? Восстанавливает iptables ? </P>

<P><CODE>
<BR>pre-up iptables-restore &lt; /etc/iptables.up.rules
<BR></CODE></P>

<P>Точнее, что значит тут pre-up, -пред запуск ?</P>

<P><CODE>
<BR>$ man pre-up
<BR>No manual entry for pre-up
<BR></CODE></P>

<P>pre-up, post-up, pre-down, post-down - очень интересные штуки. Они указывают какие команды нужно запустить до, после включения и отключения интерфейсов.</P>

<P>Например, после поднятия ppp0 можно организовать чтобы автоматом включилась аська, торент начал докачивать порево, амарок включил музон.... ну я думаю мысля ясна.</P>

<P>p.s.
<BR>iptables-save - выводит текущие правила фаервола на стандартный вывод: на экран (название обманчивое. эта команда ничего нигде не сохраняет). Сохранять нужно "вручную": сохранить текущие настройки фаера в файл (iptables-save >> /etc/MySuperRules) и потом восстановить их (iptables-restore << /etc/MySuperRules) . После перезагрузки системы, настройки фаера обнуляются и чтобы постоянно не вбивать команды в консоли их впихивают в автозагрузку (правильнее конечно в interfaces pre-up или post-up).</P>

<P>p.s.
<BR>А man нужно смотреть не для pre-up, а для interfaces</P>

<P><CODE>
<BR>$ sudo su
<BR>
<OL>
<LI>echo 0 > /proc/sys/net/ipv4/ip_forward</LI>
</OL></CODE></P>

<P>
<OL>
<LI>command и $ sudo command Это конечто одно и тоже. Но когда делается перенаправдение вывода (">") то оно делается с правами основного пользователя</LI>
</OL>
<BR>То есть когда делаешь sudo echo 0 > /proc/sys/net/ipv4/ip_forward то собственно отоборажение единички происходит от рута, а вот помещение ее в файл - от обычного пользователя. По этому и недостаточно прав.</P>

<P>А решить это можно несколькими способами:</P>

<P><CODE>
<BR>sudo su -c "echo 0 > /proc/sys/net/ipv4/ip_forward"
<BR>echo 0 > sudo tee /proc/sys/net/ipv4/ip_forward
<BR></CODE></P>

<P>и тд</P>

<P>Настройки хранятся в /etc/sysctl.conf. Для их изменения используется утилита sysctl. И не нужно выдумывать новых путей.</P>

<P>- посмотреть все настройки</P>

<P><CODE>
<BR>sysctl -a
<BR></CODE></P>

<P>- посмотреть настройки только для одного параметра</P>

<P><CODE>
<BR>sysctl net.ipv4.ip_forward
<BR></CODE></P>

<P>(как всегда для продолжения названия параметра работает наш любимый TAB)</P>

<P>- изменить настройки</P>

<P><CODE>
<BR>sudo sysctl net.ipv4.ip_forward=1
<BR></CODE></P>

<P><HR></P>

<P>Имею компьютер с ubuntu desk top 9.04, он подключен к интернету через adsl модем, который сам (модем) настроен на авто залогинивание у провайдера с предоставлением логина и пароля и передает уже готовый интернет на сетевую карту eth1.  Вторая сетевая карта называется eth6 и смотрит в локальную сеть. </P>

<P>Настройки eth1 такие: адрес - <A HREF="http://192.168.211.199">192.168.211.199</A> маска - <A HREF="http://255.255.255.0">255.255.255.0</A> шлюз - <A HREF="http://192.168.211.33">192.168.211.33</A> dns - <A HREF="http://192.168.1.1">192.168.1.1</A></P>

<P>Как раздавать интернет всем компам локальной сети с присвоением каждому компу автоматического ip адреса и автоматического dns?</P>

<P>Что прописать в настройках eth6?</P>

<P>dhcp включить на одной карте на других получить автоматически</P>

<P>а вроде так не может быть <A HREF="http://192.168.21.199">192.168.21.199</A> маска - <A HREF="http://255.255.255.0">255.255.255.0</A> шлюз - <A HREF="http://192.168.211.33">192.168.211.33</A> наверно шлюз тоже 21 а не 211</P>

<P>
<OL>
<LI>воткнуть все компы в модем. Если не хватает портов, купить свич.</LI>
<LI><A HREF="http://forum.ubuntu.ru/index.php?topic=3244.0">http://forum.ubuntu.ru/index.php?topic=3244.0</A></LI>
<LI>поиск по форуму и не только ибо, по-моему, уже по 5 раз на дню появляются вопросы как поднять шлюз.</LI>
</OL>
<BR>Есть ли у кого толковое описание как раздать интернет при помощи firestarter? У меня при использовании мастера он всегда выдает ошибку что устройство eth6 не готово, как нужно его подготовить?</P>

<P><CODE>
<BR>echo 1 >/proc/sys/net/ipv4/ip_forward
<BR>iptables -A FORWARD -p tcp -m tcp --tcp-flags SYN,RST SYN -j TCPMSS --clamp-mss-to-pmtu
<BR>iptables -t nat -A POSROUTING -s * -j MAQSUERADE
<BR></CODE></P>

<P>
<UL>
<LI>-- диапазон домашней локалки (<A HREF="http://192.168.0.0/24">192.168.0.0/24</A> например)</LI>
</UL>
<BR><HR></P>

<P>Реализовывать можно как в ручную так и с помощью скрипта, вот кстати и он:</P>

<P><CODE>
<BR>
<OL>
<LI>Включаем форвардинг пакетов из одного сетевого интерфейса в другой ( сколько бы их не было)</LI>
</OL>echo 1 > /proc/sys/net/ipv4/ip_forward
<BR>
<OL>
<LI>Для реализации NAT нужена программа под названием  iptables, проверьте есть ли она у вас и где она расположена</LI>
</OL>
<BR>
<OL>
<LI>which iptables</LI>
</OL>/sbin/iptables
<BR>Как раз то что нужно.
<BR>
<OL>
<LI>Указываем интерфейс смотрящий в интернет (в нашем случае это eth0 )</LI>
</OL>/sbin/iptables –table nat –append POSTROUTING –o eth0 -j MASQUERADE
<BR>
<OL>
<LI>Указываем интерфейс смотрящий в LAN</LI>
</OL>/sbin/iptables –append FORWARD –o eth1 -j ACCEPT
<BR>
<OL>
<OL>
<OL>
<LI></LI>
</OL>
</OL>
</OL></CODE></P>

<P>Также  эти строки можно поместить в 1 файл, к примеру NAT.sh, положить его в каталог пользователя ROOT и сделать его исполняемым ‘chmod 755 ‘. Вот его содержимое:</P>

<P><CODE>
<BR>
<OL>
<LI>!/bin/sh</LI>
</OL>echo 1 > /proc/sys/net/ipv4/ip_forward
<BR>/usr/sbin/iptables –append FORWARD –o eth0 -j ACCEPT
<BR>/usr/sbin/iptables –table nat –append POSTROUTING –o eth1 -j MASQUERADE
<BR></CODE></P>

<P>Если вы хотите чтобы этот скрипт запускался при старте системы, поместите ссылку на него в файл</P>

<P><CODE>
<BR>
<OL>
<LI>echo «/root/NAT.sh >> /etc/rc.local »</LI>
</OL></CODE></P>

<P>После чего настройте сетевое соединение у клиента вашей локальной сети указав правильные IP/Netmask/GW, а так же DNS. Не помните DNS вашего провайдера? Используйте публичные к примеру от Google их адреса просто запомнить <A HREF="http://8.8.8.8">8.8.8.8</A> и <A HREF="http://8.8.4.4">8.8.4.4</A>.</P>

<P><HR></P>

<P>На втором в настройках сетевого подключения (указываются вручную) прописано:</P>

<P>IP-адрес: <A HREF="http://192.168.0.2">192.168.0.2</A>
<BR>Маска подсети: <A HREF="http://255.255.255.0">255.255.255.0</A>
<BR>Основной шлюз: <A HREF="http://192.168.0.1">192.168.0.1</A>
<BR>DNS-серверы: указываю провайдерские</P>

<P>На первом в Ubuntu подключение к провайдеру через USB у меня определяется как eth1, а сетевое подключение на второй комп — eth0.</P>

<P>eth1 настраиваю вручную (ввожу IP, маску сети, основной шлюз и DNS-сервера — их беру в Windows из сведений о подключении). Автоматическое подключение в Ubuntu у меня почему-то работает только до первой после установки перезагрузки (это уже не впервый раз, почему, пока не знаю).</P>

<P>Дальше настраиваю раздачу интернета (помогло это руководство):</P>

<P><CODE>
<BR>sudo ifconfig eth0 <A HREF="http://192.168.0.1">192.168.0.1</A> netmask <A HREF="http://255.255.255.0">255.255.255.0</A>
<BR>sudo ifconfig eth0 up
<BR></CODE></P>

<P>Затем в файле /etc/sysctl.conf вписать строчку:</P>

<P><CODE>
<BR>net.ipv4.ip_forward=1
<BR></CODE></P>

<P>(у меня она оказалась вписанной, нужно было её просто раскомментировать).</P>

<P>Команда, чтобы применить это правило до перезагрузки:</P>

<P><CODE>
<BR>sudo sysctl -w net.ipv4.ip_forward="1"
<BR></CODE></P>

<P>(действительно, больше вводить её не понадобилось).</P>

<P>И последний шаг:</P>

<P><CODE>
<BR>sudo iptables -t nat -A POSTROUTING -o eth1 -j MASQUERADE
<BR></CODE></P>

<P>ifconfig и iptables приходится выполнять каждый раз после перезапуска Ubuntu. Вероятно, это можно автоматизировать, но пока не знаю как (настроить eth0 через графический интерфейс, как eth1, не получается — в этом случае интернет не работает). В общем, до окончательной ясности ещё далеко, но хорошо, что уже работает. Странно, почему то же не получалось раньше. Вроде бы то же самое проделывал, но не срабатывало.</P>

<P>Обн. 11.04.2010: Можно создать исполняемый файлик  /home/andrey/razdacha-ineta из четырёх строчек:</P>

<P><CODE>
<BR>
<OL>
<LI>!/bin/sh</LI>
</OL>ifconfig eth0 <A HREF="http://192.168.0.1">192.168.0.1</A> netmask <A HREF="http://255.255.255.0">255.255.255.0</A>
<BR>ifconfig eth0 up
<BR>iptables -t nat -A POSTROUTING -o eth1 -j MASQUERADE,
<BR>и когда нужно раздать интернет, просто запускать его:
<BR>sudo ~/razdacha-ineta
<BR></CODE></P>
</BODY>
</HTML>