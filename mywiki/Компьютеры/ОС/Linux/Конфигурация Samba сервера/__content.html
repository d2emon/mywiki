<!DOCTYPE html>
<HTML>
<HEAD>
	<META HTTP-EQUIV='CONTENT-TYPE' CONTENT='TEXT/HTML; CHARSET=UTF-8'/>

	<STYLE type="text/css">
		body, div, p, table {
			font-size:10pt;
			font-family:Verdana;
		}

		img{border:none}
		
	</STYLE>
	
</HEAD>

<BODY>
<P>
<H1>Конфигурация Samba сервера</H1></P>

<P>Здесь я попробую рассказать вам о том, что надо сделать, для того чтобы, использовать linux-samba сервер в качестве контролера домена для Windows сети. Также будет рассмотрено управление пользователями и профилями. Этот документ относиться к Debian CNU/Linux 2.2 так что ваш smb.conf может отличаться в зависимости от дистрибутива. Для написания статьи использовалась samba 2.0.7</P>

<P><HR></P>

<P>
<H2>Инсталяция Samba</H2></P>

<P>Будем считать что вы немного знакомы с samba и он установлен на вашем сервере. Если это не так, то для быстрой установки попробуйте:</P>

<P>Debian: apt-get install samba
<BR>RedHat(Mandrake): rpm -vih /mnt/cdrom/RedHat(Mandrake)/RPMS/samba*
<BR> 
<H2>Файл конфигурации: основные параметры</H2></P>

<P>Samba использует свой собственный файл конфигурации который состоит из секций, таких как приведенная ниже [global] и [tmp].</P>

<P><I>Файл настройки только для samba!</I></P>

<P>
<PRE>
&amp;lt;минимальный smb.conf file&amp;gt;
[global]
   printing = bsd
   printcap name = /etc/printcap
   load printers = yes
   guest account = pcguest

   log file = /usr/local/samba/log.%m

[tmp]
  comment = Temporary file space
  path = /tmp
  read only = yes
  public = yes
&lt;/file&gt;
</PRE></P>

<P>Если вы запустите samba с этим конфигом, то все windows машины в вашей локальной сети смогут увидеть в своем сетевом окружении машину, которая называется так же как ваш linux сервер и которая имеет разделяемый ресурс tmp, в который для всех разрешена запись.</P>

<P>Внимание: когда вы изменяете ваш конфигурационный файл, вы должны перезапустить samba командой/etc/init.d/samba restart script (для debian)
<BR> 
<H2>Файл конфигурации, идем дальше</H2></P>

<P>Давайте рассмотрим следующие параметры:</P>

<P>
<H3>Секция [global]</H3></P>

<P>
<UL>
<LI>netbios name:
<BR>Netbios имя вашего сервера (то имя, которое вы увидите в сетевом окружении вашей windows машины), если не сделаете этого, то будет использовано имя сервера (hostname).</LI>
<LI>invalid users:
<BR>Список пользователей которым запрещен доступ, например "root" рекомендуется включить в этот список.</LI>
<LI>interfaces:
<BR>Если машина имеет несколько сетевых интерфейсов, то нужно указать какой необходимо использовать samba серверу.</LI>
<LI>security:
<BR>Выбор режима безопасности, при security=user каждый пользователь должен иметь учетную запись (account) на GNU/Linux сервере, если вы хотите что бы samba сервер управлял доступом и пользователями, то используйте security=share.</LI>
<LI>workgroup:
<BR>Рабочая группа.</LI>
<LI>server string:
<BR>Описание вашего компьютера.</LI>
<LI>socket options:
<BR>Опции сокета, с их помощью можно (и нужно) оптимизировать работу samba.</LI>
<LI>encrypt passwords:
<BR>Должны ли вы использовать зашифрованные пароли? Это важно знать, потому, что каждая версия windows (почти) использует различные схемы авторизации.</LI>
<LI>wins support:
<BR>Должен ли ваш сервер быть wins сервером?</LI>
<LI>os level:
<BR>Определяет шансы samba сервера стать local mastero`ом для своей рабочей группы (чем выше значение тем меньше у конкурирующего сервера шансов).</LI>
<LI>domain master:
<BR>Работать как domain master.</LI>
<LI>local master:
<BR>Как local master.</LI>
<LI>preferred master:
<BR>Это опция вместе с domain master = yes практически гарантирует, что ваш samba сервер станет domain master`ом</LI>
<LI>domain logons:
<BR>Тrue если хотите чтобы samba выполняла функции ПЕРВИЧНОГО КОНТРОЛЕРА ДОМЕНА (PDC), для дополнительной информации по этому вопросу прочтите Samba-PDC-HOWTO.</LI>
<LI>logon script:
<BR>Скрипт, который выполняется, когда пользователь успешно логиниться.</LI>
<LI>logon path:
<BR>Путь для скриптов.</LI>
<LI>logon home:
<BR>Тут храним профили юзеров.</LI>
<LI>name resolve order:
<BR>Порядок разрешения имен.</LI>
<LI>dns proxy:
<BR>Будем ли работать как DNS прокси?</LI>
<LI>preserve case:</LI>
<LI>short preserve case:
<BR>Эти два параметра решают вопросы связанные со строчными и заглавными буквами (как известно в Unix ситемах это разные буквы а в Windows - одинаковые) .</LI>
<LI>unix password sync:
<BR>Будет ли samba синхронизировать Unix и Samba пароли ?</LI>
<LI>passwd program:
<BR>Программа для синхронизации паролей.</LI>
<LI>passwd chat:
<BR>"Чат" протокол для смены пароля.</LI>
<LI>max log size:
<BR>Максимальный размер для лог файла.</LI>
</UL>
<H3>Section [netlogon]</H3></P>

<P>Описываем ресурс netlogon.</P>

<P>
<H3>Section [profiles]</H3></P>

<P>Ресурс profiles.</P>

<P>
<H3>Section [homes]</H3></P>

<P>Здесь home директории для каждого пользователя.
<BR> 
<H2>Переменные</H2></P>

<P>Переменные клиента
<BR><TABLE ><TR><TD>Переменная</TD><TD>Описание</TD></TR><TR><TD>%a</TD><TD>Архитектура клиента
<BR>Например: Win95, WinNT, Samba ...</TD></TR><TR><TD>%I</TD><TD>IP адрес клиента</TD></TR><TR><TD>%m</TD><TD>NETBIOS имя клиента</TD></TR><TR><TD>%M</TD><TD>DNS имя клиента</TD></TR></TABLE>
<BR>Переменные пользователя
<BR><TABLE ><TR><TD>Переменная</TD><TD>Описание</TD></TR><TR><TD>%g</TD><TD>первичная группа</TD></TR><TR><TD>%H</TD><TD>домашняя директория</TD></TR><TR><TD>%u</TD><TD>имя юзера</TD></TR></TABLE>
<BR>Переменные расшаренных ресурсов
<BR><TABLE ><TR><TD>Переменная</TD><TD>Описание</TD></TR><TR><TD>%P</TD><TD>Корневая папка ресурса</TD></TR><TR><TD>%S</TD><TD>Имя ресурса</TD></TR></TABLE>
<BR>Переменные сервера
<BR><TABLE ><TR><TD>Переменная</TD><TD>Описание</TD></TR><TR><TD>%h</TD><TD>DNS имя</TD></TR><TR><TD>%L</TD><TD>NETBIOS имя</TD></TR><TR><TD>%v</TD><TD>версия Samba</TD></TR></TABLE>
<BR>Другое
<BR><TABLE ><TR><TD>Переменная</TD><TD>Описание</TD></TR><TR><TD>%T</TD><TD>Текущая дата и время</TD></TR></TABLE>
<BR>Пример использования переменных: в сети где есть windows 3.11 и windows 98 вы можете создать 2 конфигурационных файла, по 1 для каждой системы используя переменную %a.</P>

<P>
<H2>Итак: наш конфиг файл</H2></P>

<P>&lt;smb.conf file&gt;</P>

<P>
<PRE>
[global]
printing = bsd
printcap name = /etc/printcap
load printers = yes
guest account = nobody
invalid users = root

; указываем netbios имя
netbios name = pantoufle
; и подсеть в которой работаем
interfaces = 192.168.0.1/255.255.255.0

; режим user подразумевает что каждый пользователь имеет учетную запись на unix сервере
security = user

; рабочая группа
workgroup = rycks
; описание компьютера
; %h - DNS имя сервера, %v версия samba
server string = %h server (Samba %v)

; samba ведет свои собственные логи 
syslog only = no
syslog = 0;

; оптимизация соединений
socket options = IPTOS_LOWDELAY TCP_NODELAY \
SO_SNDBUF=4096 SO_RCVBUF=4096

; используем зашифрованные пароли !!!! для этого нужно пропатчить w95 и NT4
encrypt passwords = yes

; Wins сервер позволяет использовать разделяемые ресуры нескольких подсетей 
wins support = yes

; OS level. См. выше 
os level = 34

; управление доменом
local master = yes
preferred master = yes

; уравление входом в домен
domain logons = yes

; скрипт выполняемый при коннекте клиента (на машине клиента)
logon script = %g.bat
; директория для скриптов
logon path=\\%L\netlogon
; здесь храним профили
logon home=\\%L\%U\winprofile

; в этом порядке идет поиск имен 
; ВНИМАНИЕ: bcast в конце в отличии от windows
name resolve order = lmhosts host wins bcast

; работа DNS proxy
dns proxy = no

; регистр букв !!!!
preserve case = yes
short preserve case = yes

; синхронизация samba и unix паролей
unix password sync = yes

; способ синхронизации
passwd program = /usr/bin/passwd %u
passwd chat = *Enter\snew\sUNIX\spassword:* \
%n\n *Retype\snew\sUNIX\spassword:* %n\n .

; максимальный размер логфайла (строк)
max log size = 1000

; tine сервер
; сихронизировать будем с помощью .bat файла
time server = yes

; ресурс netlogon используется только во время установки соединения 
; поэтому нет необходимости делать его публичным
[netlogon]
path = /home/netlogon/%g
public = no
writeable = no
browseable = no

; каждому клиенту по собственной директории 
[homes]
path = /home/%user
comment = Home Directories
browseable = no
read only = no
create mask = 0700
directory mask = 0700

; для удобства можно расшарить и FTP 
; чтобы доступ осуществлялся не только с помощью FTP клиента 
[ftp]
path = /home/ftp/pub
public = yes
printable = no
guest ok = yes

; tmp 
[tmp]
path = /tmp
public = yes
printable = no
guest ok = yes
writable = yes

; tmp для отдельных юзеров 
[bigtemp]
path = /home/bigtemp
public = yes
printable = no
guest ok = yes
valid users = erics
writable = yes

&amp;lt;/smb.conf file&amp;gt;

</PRE>
<BR> 
<H2>Что же должно быть на сервере ?</H2></P>

<P>На сервере мы должны иметь:
<BR>
<UL>
<LI>учетные записи для каждого клиента (account)</LI>
<LI>smb.conf файл</LI>
<LI>директорию /home/netlogon (в моем примере)</LI>
<LI>.bat файл для каждого пользователя и группы (примеры см. ниже)</LI>
<LI>файл CONFIG.POL для осуществления вашей политики безопасности (в директории /home/netlogon).</LI>
<LI>для создания файла config.pol понадобится poledit.exe.</LI>
</UL>
<BR>
<PRE>
&amp;lt;file /home/netlogon/admin.bat&amp;gt;
net use P: \\pantoufle\homes
net use T: \\pantoufle\tmp
net time \\pantoufle /SET /YES
&amp;lt;/file admin.bat&amp;gt;

&amp;lt;file /home/netlogon/teachers/teachers.bat&amp;gt;
net use P: \\pantoufle\homes
net use T: \\pantoufle\tmp
net time \\pantoufle /SET /YES
regedit /s \\pantoufle\netlogon\teachers.reg
&amp;lt;/file teachers.bat&amp;gt;

&amp;lt;file /home/netlogon/pupils/pupils.bat&amp;gt;
net use P: \\pantoufle\homes
net use T: \\pantoufle\tmp
net time \\pantoufle /SET /YES
regedit /s \\pantoufle\netlogon\pupils.reg
&amp;lt;/file pupils.bat&amp;gt;

&amp;lt;file /home/netlogon/teachers/teachers.reg&amp;gt;
[HKEY_CURRENT_USER\Software\Microsoft\Windows
\CurrentVersion\Explorer\User Shell Folders]
&quot;Personal&quot;=&quot;P:\\&quot;
&amp;lt;/file teachers.reg&amp;gt;

&amp;lt;file /home/netlogon/pupils/pupils.reg&amp;gt;
[HKEY_CURRENT_USER\Software\Microsoft\Windows
\CurrentVersion\Explorer\User Shell Folders]
&quot;Personal&quot;=&quot;P:\\&quot;
&amp;lt;/file pupils.reg&amp;gt;
</PRE></P>

<P>Эти файлы позволяют при загрузке автоматически подключать персональный ресурс как диск P:\ и tmp ресурс как диск T:\ . Так же происходит синхронизация времени.</P>

<P>ВНИМАНИЕ: .bat файл должен быть в так называемом "DOS mode" (т.е. иметь все символы из DOS кодировки), для этого лучше всего создавайте его в блокноте (notepad) .</P>

<P>
<H2>Defining the system security policy (C) (TM) (R)</H2></P>

<P>Этот заголовок взят из документации MS :o).</P>

<P><I>Безопасночть в Windows почти возможна используя контролеры доменов.</I></P>

<P>Итак для воплощения в жизнь вашей политики безопасности (еще я думаю подойдет термин настройки системы), например для запрета запуска утилиты regedit, DOS программ и т.д., вам необходимо использовать программу POLEDIT из дистрибутива поставки Windows 98 .</P>

<P>Запускайте poledit, читайте документацию, пробуйте: но эта статья не об этом.</P>

<P>Итак, когда ваш .POL файл создан, скопируйте его в директорию ресурса [netlogon].</P>

<P>ВНИМАНИЕ: Для Win9X клиентов настройки должны быть в файле CONFIG.POL ... для WindowsNT он должен иметь другое имя, но я не знаю какое так как ей не полюзуюсь:( И пожалуйста не присылайте мне NT даже для теста. Хотя все равно спасибо за такие предложения :o)</P>

<P>ЗАМЕЧАНИЕ: PolEdit разрешает создавать пользователей и группы. Работает, правда, это только с пользователем установленным по умолчанию.</P>

<P>Например, если я создаю группу "admin" в PolEdit, которой можно запускать regedit, когда я подсоединяюсь под именем "erics" ("admin" является его личной группой), regedit у меня не запускается :(.</P>

<P>Хотя, если создать пользователя "erics" в poledit ... все работает.</P>

<P>Учитывая то, что нам не очень хочется создавать 1056 пользователей poledit и управлять всеми пользоателями сразу намного интереснее, мы предлагаем следующую хитрость:</P>

<P>Для осуществления плана мы обошли проблему: мы создали 3 config.pol файла только пользователями по умолчанию, итак, на linux сервере получилось:</P>

<P>/home/netlogon/teachers/CONFIG.POL
<BR>/home/netlogon/teachers/teachers.bat
<BR>/home/netlogon/pupils/CONFIG.POL
<BR>/home/netlogon/pupils/pupils.bat
<BR>/home/netlogon/admin/CONFIG.POL
<BR>/home/netlogon/admin/admin.bat</P>

<P>И немного изменили файл smb.conf чтобы она учитывала это:</P>

<P>
<PRE>
&amp;lt;smb.conf file&amp;gt;
[netlogon]
; мы добавили %g чтобы переместить netlogon в другую дирректорию в зависимости от
; группы пользователей, к которой файл config.pol обращается в зависимости от группы
; пользователей
path = /home/netlogon/%g
public = no
writeable = no
browseable = no
&amp;lt;/smb.conf file&amp;gt;
</PRE> </P>

<P>
<H3>Настройки компьютеров под Windows</H3></P>

<P><I>Немного удачи, 20 кликов мыши и перезагрузок наверно хватит для настройки windows!</I></P>

<P>Для клиента под Win98</P>

<P>Нажмите на Start/Parameters/Configpanel (Пуск/Панель управленя/Сеть) и дважды кликните на Network</P>

<P>Необходимы::</P>

<P>
<UL>
<LI>Клиент для сетей Майкрософт</LI>
<LI>Драйвер сетевой карты</LI>
<LI>Поддержка TCP/IP и ТОЛЬКО TCP/IP (не ipx или netbios)</LI>
<LI>Доступные принтеры и папки</LI>
</UL>
<BR>Потом нажмите на закладку "Identification" (Идентификация) и дайте компьютеру имя и название группы.</P>

<P>Нажмите на "Access control" и выберите права доступа пользователя</P>

<P>Вернитесь к закладке настроек и нажмите на "Client for MS network" (Клиент для сетей Майкрософт)</P>

<P>Не забудьте настроить поддержку TCP/IP:</P>

<P>дважды нажмите на TCP/IP</P>

<P>IP address:</P>

<P>
<UL>
<LI>IP address для этой машены (пример: <A HREF="http://192.168.0.2">192.168.0.2</A>)</LI>
<LI>Маска подсети (пример: <A HREF="http://255.255.255.0">255.255.255.0</A>)</LI>
</UL>
<BR>Настройка WINS:</P>

<P>
<UL>
<LI>Активизировать WINS разрешение</LI>
<LI>Добавить WINS сервер, IP <A HREF="http://192.168.0.1">192.168.0.1</A> (если это IP address samba сервера)</LI>
<LI>Gateway: если есть здесь можно настроить</LI>
<LI>Настройки DNS: настроить доступ к DNS</LI>
</UL> 
<H2>Замечания "скорость/быстродействие?"</H2></P>

<P>Во время работы, обращения проходят довольно быстро потому что используются профили windows.</P>

<P>Но, profile полон вещей которые MS считает необходимыми, такие как IE cache, OutLook cache, и т.д.</P>

<P>Это значт что около 10 MB будет грузиться при подключении к машине и 10 MB будет передаватья серверу при отключении.</P>

<P>10 MB для каждого пользователя, для 15 компьютеров ("нормальный" размер лаборатории, например), получается 150 MB, а если в здании 10 комнат... можно подсчитать время отключения от сети в конце рабочего дня.</P>

<P>Поэтому лучше домашней директорией сделать P: (например, P как Personal) для каждого и приучить пользователей: "сохраняйте докумнты в P а не в "My documents", иначе обратно вы их не получите ".</P>

<P>Надо найти софт чтобы настроить закладки в P:\bookmarks.html и т.п.</P>

<P>Я не знаю существует ли это в мире windows!</P>

<P>
<H2>Вопросы и предложения</H2></P>

<P>Возможно ли создавать различные группы на домене, как этим управлять?</P>

<P>Как использовать NT и Samba серверы?</P>

<P>Настройка клиентов NT аналогична CONFIG.POL но под NT имеет другое название.</P>

<P> !!! Благодарности</P>

<P>Bruno <bcarrere(at)asp-france.fr> за помощь:o)</P>

<P>JohnPerr за помощь в написании и перевод на English.
<BR>Michel Billaud aka MiB за найденые им решения нашим проблемам :o)
<BR>Etienne, Éric, спасибо за то что поделились знаниями по NT серверам.
<BR>Jean Peyratout слишком долго рассказывать за что :)  </P>

<P>
<H2>Ссылки</H2></P>

<P>Onlin O'Reilly book: <A HREF="http://www.oreilly.com/catalog/samba/chapter/book/index.html">http://www.oreilly.com/catalog/samba/chapter/book/index.html</A></P>
</BODY>
</HTML>