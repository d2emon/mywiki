<!DOCTYPE html>
<HTML>
<HEAD>
	<META HTTP-EQUIV='CONTENT-TYPE' CONTENT='TEXT/HTML; CHARSET=UTF-8'/>

	<STYLE type="text/css">
		body, div, p, table {
			font-size:10pt;
			font-family:Verdana;
		}

		img{border:none}
		
	</STYLE>
	
</HEAD>

<BODY>
<P>
<H1>Как раздать интернет на локальную сеть</H1></P>

<P>Мы хотим, чтобы машины из локальной сети имели доступ к Internet. В данном случае наш сервер должен выполнять функции роутера (маршрутизатора). В нем должно быть как минимум два интерфейса:</P>

<P>
<UL>
<LI>один подключен к интернет-провайдеру (пусть это eth0);</LI>
<LI>а второй включен во внутреннюю сеть (пусть это eth1);</LI>
</UL>
<BR>Для “раздачи” интернет во внутреннюю сеть часто используется IP маскарадинг (IPMASQUARADE). Работает это, вкратце, следующим образом: пакет, [4] поступающий из локальной сети на роутер, в своем заголовке содержит IP адрес создавшего его компьютера (далее ip-источника) и IP-адрес пункта назначения (далее ip-получателя). Роутер в этом случае подменяет ip-источника на свой ip и отправляет этот пакет получателю. Получатель формирует ответный пакет для роутера. Роутер принимает этот пакет, но он знает, что этот пакет предназначен не ему (путем запоминания номера пакета) и, заменяет в нем ip-получателя на ip-источника, затем отправляет этот пакет локальной машине в сети. Таким образом, получается, что машины во внутренней сети получают доступ в интернет от имени роутера. Отсюда и название “IP-маскарадинг”, так как маршрутизатор маскирует своим IP машины внутри локальной сети. Это дает возможность серьезно повысить защищенность рабочих станций внутри сети и обеспечить их интернетом без раздачи им реальных IP адресов.</P>

<P>В отличии от прокси сервера (например SQUID), этот способ позволяет хорошо работать не только http, но и ftp/pop3/smtp/ssh/telnet/...... практически ЛЮБОМУ сервису. При этом не нужно объяснять сервису, что он работает через прокси.</P>

<P>Делаеться это одной командой:</P>

<P>
<PRE>
         # iptables -t nat -A POSTROUTING -o &lt;интерфейс, который наружу&gt; -s &lt;докальная сетка&gt; -j MASQUERADE
</PRE>
<BR>      
<BR>Не забываем включить перенаправление пакетов:</P>

<P>
<PRE>
         # echo 1 &amp;gt;/proc/sys/net/ipv4/ip_forward
</PRE>
<BR>      
<BR>Полное описание того, что такое IP-Masquarade и как его настраивать на английском языке, можно получить здесь: <A HREF="http://www.ibiblio.org/pub/Linux/docs/HOWTO/other-formats/html/IP-Masquerade-HOWTO-html.tar.gz">http://www.ibiblio.org/pub/Linux/docs/HOWTO/other-formats/html/IP-Masquerade-HOWTO-html.tar.gz</A>. В частности, оттуда нас интересует раздел: 3.4.1. Выбираем оттуда первый примерчик (выделенный серым цветом), копируем его в файл и делаем этот файл запускаемым.</P>

<P>В адаптированном для Linux Mandrake 9.1-9.2 виде этот скрипт можно получить здесь: <A HREF="http://lafox.net/docs/masq/">http://lafox.net/docs/masq/</A>. Для других дистрибутивов, вероятно, нужно поправить пути в переменных : IPTABLES, DEPMOD, MODPROBE.</P>

<P>В сокращенном виде (без комментариев и нефункциональных выводов сообщений) скрипт выглядит так:</P>

<P>
<PRE>
#!/bin/sh
# полная версия находится здесь: http://lafox.net/docs/masq/
IPTABLES=/sbin/iptables
DEPMOD=/sbin/depmod
MODPROBE=/sbin/modprobe

EXTIF=&quot;eth0&quot;
INTIF=&quot;eth1&quot;

$DEPMOD -a

$MODPROBE ip_tables
$MODPROBE ip_conntrack
$MODPROBE ip_conntrack_ftp
$MODPROBE ip_conntrack_irc
$MODPROBE iptable_nat
$MODPROBE ip_nat_ftp
$MODPROBE ip_nat_irc

echo &quot;1&quot; &gt; /proc/sys/net/ipv4/ip_forward
echo &quot;1&quot; &gt; /proc/sys/net/ipv4/ip_dynaddr

$IPTABLES -P INPUT ACCEPT
$IPTABLES -F INPUT 
$IPTABLES -P OUTPUT ACCEPT
$IPTABLES -F OUTPUT 
$IPTABLES -P FORWARD DROP
$IPTABLES -F FORWARD 
$IPTABLES -t nat -F

$IPTABLES -A FORWARD -i $EXTIF -o $INTIF -m state --state ESTABLISHED,RELATED -j ACCEPT
$IPTABLES -A FORWARD -i $INTIF -o $EXTIF -j ACCEPT
$IPTABLES -A FORWARD -j LOG

$IPTABLES -t nat -A POSTROUTING -o $EXTIF -j MASQUERADE

echo -e &quot;done.\n&quot;
</PRE></P>

<P>Давайте сохраним это в файлик и назовем его, к примеру masq.sh. Далее поправляем переменные:</P>

<P>
<PRE>
EXTIF=&quot;eth0&quot;
INTIF=&quot;eth1&quot;
</PRE></P>

<P>
<UL>
<LI>EXTIF - это название интерфейса, который “смотрит” в сторону провайдера.</LI>
<LI>INTIF - это название интерфейса, который “смотрит” во внутреннюю сеть.</LI>
</UL>
<BR>Также, возможно, следует закомментировать строку:</P>

<P> 
<PRE>
$IPTABLES -A FORWARD -j LOG
</PRE></P>

<P>Этим мы отключим логирование. Иначе, в больших сетях могут возникнуть проблемы с огромными размерами log файлов.</P>

<P>Далее просто запускаем этот скрипт и радуемся тому, что локальная сеть получила интернет. :-)</P>

<P>Посмотреть на то, что сделал этот скрипт с iptables, можно командочками:</P>

<P>
<PRE>
# iptables -L
# iptables -L -t nat
</PRE></P>

<P>IP-маскарадинг часто используется совместно с кэширующим прокси-сервером. О том, как его настроить читайте здесь: Глава 6. Настройка кэширующего прокси-сервера.</P>

<P><HR></P>

<P>[4] IP пакет также часто называют datagram.</P>
</BODY>
</HTML>