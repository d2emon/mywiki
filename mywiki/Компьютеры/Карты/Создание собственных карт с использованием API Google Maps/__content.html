<!DOCTYPE html>
<HTML>
<HEAD>
	<META HTTP-EQUIV='CONTENT-TYPE' CONTENT='TEXT/HTML; CHARSET=UTF-8'/>

	<STYLE type="text/css">
		body, div, p, table {
			font-size:10pt;
			font-family:Verdana;
		}

		img{border:none}
		
	</STYLE>
	
</HEAD>

<BODY>
<P>
<H1>Создание собственных карт с использованием API Google Maps</H1></P>

<P>В этой заметке я рассмотрю вопрос о том, как добавить собственную карту на Google Maps.</P>

<P>Это можно сделать несколькими способами.</P>

<P>Первый способ, размещение дополнительного изображения в виде наложения на карту Google Maps.</P>

<P>Для этого в API карт Google существует объект GGroundOverlay.</P>

<P>В котором в качестве парамтров конструктора используются URL-адрес и объект GLatLngBounds изображения.</P>

<P>Объект GLatLngBounds представляет прямоугольник заданный географическими координатами.</P>

<P>Посмотрим реализацию данного способа на примере.</P>

<P>Добавим на карту Google фотографию церкви Рождества Христова в городе Балахне Нижегородской области, так, чтобы левый нижний угол совпадал по координатам с центром изображения на спутниковым снимке.</P>

<P>Вы можете  посмотреть работающий пример и исходный код здесь.</P>

<P>В коде нужно обратить Ваше внимание на две строчки:</P>

<P>
<PRE>
var boundaries = new GLatLngBounds(new GLatLng(56.489907,43.606367), new GLatLng(59.962385,48.418379));
var oldmap = new GGroundOverlay(«http://webmap-blog.ru/files/439px-Bal_Cerkov_Rojdestva_Hristova.jpg», boundaries);
</PRE></P>

<P>В первой мы задаем координаты левого нижнего и правого верхнего угла изображения, а во второй его URL-адрес.</P>

<P>Мы можем накладывать на карту фрагменты изображений.</P>

<P>Для этого используется класс GTileLayerOverlay.</P>

<P>GTileLayerOverlay дополняет карту с помощью GTileLayer. Он использует интерфейс GOverlay и таким образом добавляется в карту с помощью метода GMap2.addOverlay().</P>

<P>GTileLayer располагается поверх существующей карты.</P>

<P>Но прежде необходимо создать объект GCopyrightCollection и прикрепить  его к слою карты; так объект получает право на использование изображения (или изображений).</P>

<P>С процессом наложения фрагментов изображения я подробно опишу как-нибудь в следущий раз.</P>

<P>А сейчас мы приступим к созданию собственной карты с использованием пользовательского типа карты.</P>

<P>И для начала нам необходимо подготовить исходное растровое изображение нашей карты.</P>

<P>Разберем  с Вами как устроены карты Google , это нам поможет предварительно подготовить нашу карту.</P>

<P>В Google Maps Земля представлена в проекции Меркатора .</P>

<P>Она представляет собой развёрнутый на плоскость цилиндр, что даёт нам прямоугольник, который разбивается на маленькие квадратики (tiles) с размерами 256×256 пикселей.</P>

<P>Пример одного из элементов карты Google: <A HREF="http://mt3.google.com/mt/v=ap.95&hl=ru&x=20389&s=&y=10149&z=15&s=Gali">http://mt3.google.com/mt/v=ap.95&hl=ru&x=20389&s=&y=10149&z=15&s=Gali</A></P>

<P>Из адреса рисунка можно видеть следующие три значения:
<BR>x=20389, y=10149 и z=15</P>

<P>Здесь</P>

<P>
<UL>
<LI>х – номер элемента карты по горизонтали, числа растут слева направо (с запада на восток),</LI>
<LI>Y – номер элемента карты по вертикали, числа увеличиваются с верху вниз (с севера на юг),</LI>
<LI>Z – уровень масштаба.</LI>
</UL>Из этого следует, что нам необходимо разбить изображение нашей карты на кусочки вида ties_20389_10149_15.jpg, каждый размером 256×256 пикселей. А чтобы можно было изменять масштаб изображения, подготовить изображения нескольких масштабных уровней.</P>

<P>Каждый масштабный уровень содержит в 4 раза большее количество элементов, чем предыдущий.</P>

<P>Например, нулевой уровень – 1 элемент, следующий – 4, второй уровень – 16 и т.д.</P>

<P>Еще нам нужно узнать три тех самых числа, которые дают нам местоположение нужного фрагмента карты.</P>

<P>Самый простой вариант загрузить нужный нам участок карты и посмотреть информацию о полученных изображениях (в FireFox: Инструменты->Информация о странице — > Мультимедиа).</P>

<P>Теперь нам необходимо разрезать наше изображение.</P>

<P>Сделать это можно разными способами:</P>

<P>Использовать онлайн-сервис Gmap Uploader <A HREF="http://gmapuploader.com/">http://gmapuploader.com/</A></P>

<P>На главной странице сервиса нужно ввести Ваш адрес электронной почты, выбрать файл для загрузки в формате jpg, png или gif и нажать на кнопку Send для начала загрузки файла.</P>

<P>Через некоторое время (продолжительность зависит от размера загружаемого изображения) появиться страница с загруженным изображением в интерфейсе Google Maps.</P>

<P>И три ссылки внизу изображения.</P>

<P>Для моего примера они имеют следующий вид:</P>

<P>Link: <A HREF="http://gmapuploader.com/view/HG6r3eySJq">http://gmapuploader.com/view/HG6r3eySJq</A>
<BR>Full Screen: <A HREF="http://gmapuploader.com/iframe/HG6r3eySJq">http://gmapuploader.com/iframe/HG6r3eySJq</A>
<BR>Deep Zoom URL: <A HREF="http://dz.gmapuploader.com/HG6r3eySJq.xml">http://dz.gmapuploader.com/HG6r3eySJq.xml</A></P>

<P>Первая ссылка – адрес данной страницы, вторая на изображение карты во весь экран и третья на xml-файл с описание максимального уровня масштабирования.</P>

<P>В моем случае содержимое данного файла:</P>

<P>
<PRE>
&lt;Image TileSize=»256″ Overlap=»0″ Format=»jpg»&gt;&lt;Size Width=»4096″ Height=»4096″ /&gt;
&lt;/Image&gt;
</PRE></P>

<P>Своя карта на Google Maps с использованием сервиса Gmap Uploader</P>

<P>Это конечно хорошо, но хотелась бы, чтобы изображение элементов карты лежали на нашем сервере.</P>

<P>Для этого их необходимо загрузить на Ваш компьютер.</P>

<P>Сделать это можно по разному.</P>

<P>Приведу два способа.</P>

<P>Первый используя браузер FireFox выбрав последовательно Инструменты-&gt;Информация о странице-&gt;Мультимедиа  выделить файлы с изображением и сохранить их.</P>

<P>Проделать тоже самое для всех масштабных уровней.</P>

<P>Используя менеджер закачки файлов, например ReGet, создать очередь загрузки файлов  в текстовом файле и импортировав его загрузить все элементы.</P>

<P>Текстовый файл для нашего примера:
<BR>
<PRE>
http://mt0.gmapuploader.com/tiles/HG6r3eySJq/tile-1-0.jpg
http://mt0.gmapuploader.com/tiles/HG6r3eySJq/tile-1-1.jpg
http://mt0.gmapuploader.com/tiles/HG6r3eySJq/tile-1-2.jpg
http://mt0.gmapuploader.com/tiles/HG6r3eySJq/tile-1-3.jpg
http://mt0.gmapuploader.com/tiles/HG6r3eySJq/tile-2-0.jpg
http://mt0.gmapuploader.com/tiles/HG6r3eySJq/tile-2-1.jpg
http://mt0.gmapuploader.com/tiles/HG6r3eySJq/tile-2-2.jpg
http://mt0.gmapuploader.com/tiles/HG6r3eySJq/tile-2-3.jpg
http://mt0.gmapuploader.com/tiles/HG6r3eySJq/tile-2-4.jpg
http://mt0.gmapuploader.com/tiles/HG6r3eySJq/tile-2-5.jpg
http://mt0.gmapuploader.com/tiles/HG6r3eySJq/tile-2-6.jpg
http://mt0.gmapuploader.com/tiles/HG6r3eySJq/tile-2-7.jpg
http://mt0.gmapuploader.com/tiles/HG6r3eySJq/tile-2-8.jpg
http://mt0.gmapuploader.com/tiles/HG6r3eySJq/tile-2-9.jpg
http://mt0.gmapuploader.com/tiles/HG6r3eySJq/tile-2-10.jpg
http://mt0.gmapuploader.com/tiles/HG6r3eySJq/tile-2-11.jpg
http://mt0.gmapuploader.com/tiles/HG6r3eySJq/tile-2-12.jpg
http://mt0.gmapuploader.com/tiles/HG6r3eySJq/tile-2-13.jpg
http://mt0.gmapuploader.com/tiles/HG6r3eySJq/tile-2-14.jpg
http://mt0.gmapuploader.com/tiles/HG6r3eySJq/tile-2-15.jpg
…
http://mt2.gmapuploader.com/tiles/HG6r3eySJq/tile-4-220.jpg
http://mt2.gmapuploader.com/tiles/HG6r3eySJq/tile-4-221.jpg
http://mt2.gmapuploader.com/tiles/HG6r3eySJq/tile-4-222.jpg
http://mt2.gmapuploader.com/tiles/HG6r3eySJq/tile-4-223.jpg
http://mt2.gmapuploader.com/tiles/HG6r3eySJq/tile-4-224.jpg
</PRE></P>

<P>После этого все закаченные файлы мы помещаем в какую-нибудь папку на сервере (например, files/bal_map/) и пишем следующий код для вывода карты:</P>

<P>
<PRE>
&lt;!DOCTYPE html PUBLIC «-//W3C//DTD XHTML 1.0 Strict//EN» «http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd»&gt;&lt;html xmlns=»http://www.w3.org/1999/xhtml»&gt;
&lt;head&gt;
&lt;title&gt;Своя карта на Google Maps c использованием Gmap Uploader&lt;/title&gt;
&lt;style type=»text/css» media=»screen»&gt;
&lt;!--
html,body{
height: 100%;
margin: 0;
}
div#map{
height: 100%;
margin: 0;
}
--&gt;
&lt;/style&gt;
&lt;script src=»http://maps.google.com/maps?file=api&amp;amp;v=2&amp;amp;key=ABQIAAAACHCJdlgAEGcD_flKUFEmVhT2yXp_ZAY8_ufC3CFXhHIE1NvwkxTeukKcKHF3ezmjTB0q6gzSBmoIUQ»
type=»text/javascript»&gt;&lt;/script&gt;
&lt;script src=»http://gmapuploader.com/js/gmapuploader.8.js» type=»text/javascript»&gt;&lt;/script&gt;
&lt;/head&gt;
&lt;body onunload=»GUnload()»&gt;
&lt;div id=»map»&gt;&lt;/div&gt;
&lt;script type=»text/javascript»&gt;
//&lt;![CDATA[
var map = new GMap2(document.getElementById(&quot;map&quot;));
document.getElementById('map').style.backgroundColor = 'white';
var mapType = new GmapUploaderMapType(map, &quot;http://webmap-blog.ru/examples/files/bal_map/&quot;, &quot;jpg&quot;, 5);
map.setCenter(new GLatLng(0,0), 1, mapType);
map.addControl(new GLargeMapControl());
map.enableContinuousZoom();
//]]&gt;
&lt;/script&gt;
&lt;/body&gt;
&lt;/html&gt;
</PRE></P>

<P>Загружаем его в браузере и наблюдаем резльтат.</P>

<P>Здесь необходимо обратить внимание на следующие строчки:</P>

<P>
<PRE>
&lt;script src=»http://gmapuploader.com/js/gmapuploader.8.js» type=»text/javascript»&gt;&lt;/script&gt; — для вывода карты используется специальный скрипт сервиса Gmap Uploader.
</PRE></P>

<P>Строка var mapType = new GmapUploaderMapType(map, «<A HREF="http://webmap-blog.ru/examples/files/bal_map/">http://webmap-blog.ru/examples/files/bal_map/</A>», «jpg», 5); - в ней указывается источник файлов с изображением, расширение файла и максимальный уровень масштаба 5.</P>

<P>Другие способы добавления собственной карты на Google Maps я рассмотрю последовательно в нескольких заметках.</P>
</BODY>
</HTML>