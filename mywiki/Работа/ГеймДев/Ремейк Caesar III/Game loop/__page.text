!! Caesar III: game loop

Если бы меня спросили, какая часть технической реализации игры «Цезарь» мне интересна больше других, я бы вспомнил о расчете одного «дня» городской жизни. Отдельные компоненты математической модели города тоже интересны в реализации, но эти «шестеренки» будут крутиться только в сборе. Большая часть игры проходит внутри «игрового цикла», в котором проводятся вычисления параметров компонентов, выполняются перемещения игровых объектов, создаются новые события и объекты. Если вам интересно узнать, как была устроена симуляция города в одной из лучших игр 1998 года — добро пожаловать под кат. Описания, псевдокод и схемы помогут вам лучше узнать об используемых алгоритмах. 

%thumb%Attach:0f8d9c0c02fe4d80bed27d58be9cc2a2.jpeg%%

Обсчет одного «дня» в городе авторы игры разбили на несколько шагов, основные из которых приведены ниже, упрощенный код самой функции можно найти под спойлером:

%thumb%Attach:171ec84ad63e414c926d43e432e5b54e.jpg%%

Каждые 50 тиков начинается новый день (16 дней в игровом месяце), для которого вычисляется еще несколько функций, которые не требуют такой частой обработки, а именно:

в первый и восьмой дни месяца рассчитывается уровень счастья горожан и уровень преступности в городе;
при смене месяца выполняется проверка возможности проведения фестиваля, уплата налогов, зарплат, подсчет вероятности случайных событий и еще много чего;
при смене года выполняется сохранение параметров прошедшего года, обновление рейтингов.


Этапы расчета параметров города

Этапы расчета параметров города (код)
Наступление нового дня
Наступление нового месяца
Наступление нового года

Религия



Вначале римляне были язычниками, поклонялись греческим и в меньшей степени этрусским богам. Позже мифологический период сменился увлечением языческими культами. Государство, взяв на себя организацию и проведение ритуалов, создало официальную религию, которая изменила прежние представления о богах. Религия в жизни людей всегда имело большое значение, и компьютерные модели не избежали человеческих предрассудков, авторы игры сильно утрируют понятие благосклонности божества, сводя его к трем состояниям покарал-нейтрален-благословил, но наличие штрафов и премий делает вычисления менее предсказуемыми, также как и наличие элемента случайности при выборе божества.



Расчет настроения богов и условия гнева\благословения

Настроения в городе



Сами жители реагируют на разницу зарплат между городом и Римом, разнообразие продуктов в городе, уровень налогов и число трущоб. Данный параметр сохраняется для каждого дома и не меняется вне зависимости от соседних домов.



Расчет настроения и степени миграции в городе

Фестивали




Значительное увеличение настроения в городе дает только первый фестиваль за полные 12 месяцев, второй и последующие только половину. Сделано это для того, чтобы в богатом городе не было возможности поднять настроение только за счет фестивалей. Подготовка к самому фестивалю тоже занимает определенное время, что накладывает ограничение на количество проводимых за год фестивалей.



Расчет влияния фестиваля на настроение в городе

Выплата подати императору




Выплата дани императору. Количество денег, которое в конце года требуется выплатить из казны
зависит от прибыли города и от количества проживающих людей. Первый фактор означает выплату четверти
полученных за год денег, но не менее некоторой суммы, которая зависит от текущего населения. Если же город
не может выплатить этих денег, то правитель расплачивается снижением благосклонности императора, причем учитываются и прошлые
года невыплат, так что недовольство накапливается при длительных неуплатах дани.



Расчет имперской четвертины за последний год

Случайные события



Случайные события. В игре доступно 7 случайных событий, за их возникновение отвечает набор флагов, которые можно менять в редакторе миссий. Случайное событие возникает если генератор выбросил его тип и оно разрешено в сценарии. Разработчики сделали следующие типы: понижение/повышение зарплаты в Риме, проблемы с торговлей морской или наземной, отравление колодцев, обрушение шахт и затопление карьеров и глиняных ям. Землятрясение задается в редакторе, имеет время и точку возникновения, распространяется случайно по четырем направлениям. 

Случайные события

Здоровье жителей



Практикующие врачи сравнительно поздно появились в Риме. Вплоть до II в. до н. э., а в малоимущих слоях общества и много позднее римляне лечились у умудренных жизненным опытом своих сородичей незамысловатыми средствами, которые передавались из поколения в поколение. Эта народная медицина не чуждалась и примитивной магии. Были составлены руководства по земледелию, имеющие целый ряд указаний, как лечить людей и животных, явно следуя народным средствам.
В игре клиники и госпитали предоставляют одни и теже услуги, но госпитали также нужны для домов высокого уровня для продолжения роста. Здоровье жителей является одним из основных показателей процветания города: эпидемии могут выкашивать целые кварталы и с увеличением населения города число людей умерших при эпидемии будет только расти.



Вычисление здоровья и вероятности эпидемии в городе

Сбор налогов




На первых порах город живет за счет поступающих налогов, хотя они достаточно скромные. Сборщик налогов должен так же как например, доктор из клиники, проходить рядом с жилыми домами с определенной периодичностью. Если жилой дом бесперебойно посещается сборщиками налогов, то он каждый месяц будет платить налог.

То сколько жилой дом будет платить в месяц, зависит от:

— процентной ставки установленной у советника по финансам (регулируется от 0 до 25 %);
— количества людей проживающих в доме, на момент сбора налогов (т. е. при смене месяца);
— уровня развития дома (в игровом файле «c3_model.txt», данные по жилым домам, 20-ая колонка — это число является 200 процентным налогом в месяц с одного человека, проживающего в данном уровне развития жилого дома).

Проанализировав функцию можно сделать вывод, что плавное поднятие налогов никак не отличается от быстрого изменения. Налоги влияют на настроение ваших жителей, но нет смысла повышать зарплату своих рабочих более чем на 8 единиц, по отношению к зарплате которую платит Рим.

Что такое 200-процентный налог, это (вероятно) желание разработчиков сэкономить на операции приведения к меньшему целому, в этом блоке:

  collectedPatricians = adjustWithPercentage(
                          cityinfo.monthlyCollectedTaxFromPatricians / 2,
                          cityinfo.taxpercentage );


кода видно, что собранные налоги делятся на 2. Чтобы не получить ситуацию, когда дом может заплатить больше положенного был введен налог * 2, а при вычислениях мы всегда будем получать значение меньшее или равное правильному.

На более высоких уровнях развития города, он вполне может жить только за счет налогов:





Вычисление полученных за месяц налогов

Потребление продуктов




Люди едят Х количества пищи, независимо от того сколько у них видов еды. Съедаемое количество еды зависит только от количества человек проживаемых в доме (10 человек съедает 5 единиц еды в месяц) Например: есть жилой дом 20-го уровня, полностью заселенный т. е. в нём проживает 200 человек им необходимо 3 вида еды. Они в месяц будут съедать общее количество еды равное 200/10*5 = 100 единицам, эти 100 единиц распределятся между тремя необходимыми видами еды, скорей всего поровно, т. е. по 100/3 = 33.

Вычисление потребления для домов

Производство товаров



Иногда для производства товаров городу нужно импортировать материалы. Восемь мастерских работают стабильно с одним складом, еще две с перебоями: импорт, зависит от количества мастерских и от количества материалов, которые может предоставить торговый партнер. Экспорт можно численно регулировать, а импортируется сырье пропорционально запросу мастерских. Поэтому при небольшом количестве мастерских склад просто не будет закупать сырье про запас.

Подсчет рейтинга благосостояния



Рейтинг благосостояния в игре является самым «тяжелым» для подъема, с одной стороны любой проступок со стороны правителя ведет к его снижению, с другой — максимальный прирост уровня составляет 2 пункта, т.е. при соблюдении всех правил отметку в 50 пунктов город достигнет минимум через 25 лет, без учета штрафов и премий.



Подсчет уровня благосостояния города

Структуры данных игры




Caesar III оперирует только статическими массивами, поэтому количество зданий, людей, объектов, групп известно заранее. Так, например количество зданий и отображаемых горожан не может быть более 2000, количество групп объектов в городе (волки, овцы, легионы, протестующие) не превышает 50. Такие жесткие ограничения были наложены из-за необходимости работать с ОЗУ меньше 32Мб, из которых половина была занята архивом с текстурами. Ниже я приведу описание текстур с теми полями, физический смысл которых удалось восстановить.

(Walker) Описание подвижного объекта
(Building) Описание неподвижного объекта
(EmpireObject) Описание объекта на глобальной карте
(TradeRoute) Описание торгового марщрута
Массивы объектов

Благодарности

На волне хабраэффекта последней статьи о математической модели города игра получила «зеленый свет» в стиме , также наша команда получила большое количество пожертвований на IndieGoGo.com. Огромная благодарность хабрасообществу за поддержку ремейка. 

Посовещавшись с поклонниками игры Caesar III, мы решили приостановить внесение изменений и сосредоточиться на исправлении багов и баланса, чтобы ветка v0.4 смотрелась и игралась как оригинал. Из заметных изменений осталось только масштабирование карты и некоторое несоответствие логики отдельных юнитов.

К ремейку присоединился художник Дмитрий Плотников, который рисует новый арт 


Благодарю SkidanovAlex, Ununtrium, Bick и всем кто помог с переводом текста на indiegogo.
Большое спасибо MennyCalavera за поддержку и помощь в продвижении ремейка
Отдельная благодарность Анастасии Смольской за переводы статей 1 и 2.

Посмотреть изменения и дополнительную информацию по игре можно на странице проекта. Там же можно скачать последние сборки и написать нам о найденных багах.



P.S. Этой статьи не получилось бы без помощи Bianca van Schaik, которая очень много сил и времени потратила на восстановление исходников оригинала.

Спасибо за уделенное время
